# [章番号]: [連携機能名] 統合テスト仕様書

<!-- prettier-ignore -->
!!! note "このテンプレートの使い方"
  このファイルは、複数のコンポーネントや外部システムとの連携を検証する、統合テストの仕様を定義するためのテンプレートです。
  テスト環境の構築や、テストデータの管理方法を明確にすることが重要です。
  詳しい使い方は「[テスト仕様の書き方ガイド](ここにガイドへのパスを記述してください)」を参照してください。

## 1. はじめに

### 1.1. 目的

<!-- このテストが何を検証するのかを記述します。（例: ユーザー登録APIが、アプリケーションサービス、データベース、キャッシュと正しく連携し、一連の処理を完了できることを保証する） -->

### 1.2. テスト範囲

<!-- このテスト仕様書が対象とする連携ポイントと、対象としない範囲を明確にします。 -->

- **テスト対象範囲:**
  - [例: `/users` APIエンドポイントからデータベースへの永続化までの一連のフロー]
  - [例: ユーザー作成時のキャッシュ（Redis）更新処理]
- **テスト対象外:**
  - [例: `UserService` の個別のビジネスロジック（単体テストでカバー）]
  - [例: データベースサーバー自体の性能テスト]

## 2. テスト環境

| 項目              | 内容                                 |
| :---------------- | :----------------------------------- |
| **実行環境**      | [例: CI環境 (Docker)]                |
| **データベース**  | [例: PostgreSQL 16 (TestContainers)] |
| **キャッシュ**    | [例: Redis 7 (TestContainers)]       |
| **外部APIモック** | [例: Mockoon, WireMock]              |
| **テストツール**  | [例: Supertest (for API), Jest]      |

## 3. テストデータ管理

- **初期データ:**
  <!-- テスト実行前に必要な初期データの投入方法を記述します。 -->
  [例: `test/fixtures/base-data.sql` スクリプトをテスト実行前に実行する。]
- **テスト間の分離:**
  <!-- 各テストケースが他のテストに影響を与えないようにするための方針を記述します。 -->
  [例: 各テストケースは、個別のデータベーストランザクション内で実行し、テスト終了時にロールバックする。]

---

## 4. テストケース

<!-- ここに、検証すべき連携シナリオを見出しとリスト形式で記述します。 -->

### 4.1. [連携シナリオ1] (例: ユーザー新規作成API)

#### ケースID: `TC-INT-USER-001`

- **テスト項目:** 有効なデータでユーザーを作成する
- **テスト手順:**
  1. `POST /users` に以下の有効なユーザー情報を送信する。

     ```json
     { "name": "Test User", "email": "test@example.com" }
     ```

  2. APIからのレスポンスを確認する。
  3. データベースの`users`テーブルを直接クエリする。
  4. Redisのキャッシュを直接確認する。

- **期待される結果:**
  - **APIレスポンス:**
    - HTTPステータスが `201 Created` であること。
    - レスポンスボディに、作成されたユーザーIDが含まれること。
  - **データベース:**
    - `users`テーブルに、手順1で送信した情報を持つ新しいレコードが1件追加されていること。
  - **キャッシュ:**
    - Redisに `user:[ID]` のキーで、手順1で送信した情報と一致するユーザーデータがキャッシュされていること。
- **関連要件:** `[API-USER-1-2]`

---

#### ケースID: `TC-INT-USER-002`

- **テスト項目:** 重複したメールアドレスでユーザーを作成する
- **テスト手順:**
  1. 事前に `existing@example.com` というメールアドレスを持つユーザーをDBに作成しておく。
  2. `POST /users` に、`email`が`existing@example.com`のユーザー情報を送信する。
- **期待される結果:**
  - **APIレスポンス:**
    - HTTPステータスが `409 Conflict` であること。
  - **データベース:**
    - `users`テーブルに新しいレコードが追加されていないこと。
- **関連要件:** `[FUNC-USER-1-3]`

---

## 5. 関連ドキュメント

- **システム仕様:** `[01_システム仕様/...]`
- **設計仕様:** `[03_設計仕様/...]`
- **ユースケース:** `[02_ユースケース/...]`
