# 結合テスト規定

このドキュメントは、結合テスト（インテグレーションテスト）の実装に関する具体的な規約を定めます。結合テストは、個々のユニットが連携した際に、システムとして正しく機能することを保証します。

## 結合テストの定義と目的

- 定義:
    - 複数のコンポーネント（ユニット）を組み合わせ、それらが連携する部分を検証するテスト。
    - 単体テストではモック/スタブで置き換えていた実際の外部依存（データベース、ファイルシステム、外部APIなど）と接続してテストを行う。
- 目的:
    - コンポーネント間のインターフェースの不整合（データ形式の違い、呼び出し規約の誤りなど）を検出
    - 外部サービスとの接続が正しく行えるかを検証
    - 複数コンポーネントが絡む複雑なシナリオでのバグを検出

## 結合テストのスコープ（対象範囲）

- データベース連携
    - 実DBに対し、CRUDが正しく行えるか。トランザクション、ロールバック
- ファイルシステム連携
    - ファイルの読み書き、フォルダ作成/削除
- 外部API連携
    - サードパーティやマイクロサービス間API呼び出しが実エンドポイントに対して正しく行えるか
- メッセージキュー連携
    - RabbitMQ, Kafka等での送受信
- APIエンドポイントテスト
    - HTTPリクエストを実際に送信しレスポンスを検証（コントローラ層→ビジネス→データアクセスまでの一連）

## テスト環境の管理

- 原則: ローカルで完結させる
    - Docker Compose等で依存サービスをローカル起動して安定した実行
- テスト用データベース
    - テスト前にトランザクション開始/終了でロールバック、またはスキーマ再作成とシード投入
- 設定とシークレット
    - 接続文字列やキーは設定/環境変数から読み込み。CIではSecretsで管理

## 実装パターン

### APIエンドポイントテスト

- 目的: 外部クライアント視点でのAPI動作検証
- 推奨ツール:
    - C# (ASP.NET Core): Microsoft.AspNetCore.Mvc.Testing の WebApplicationFactory
    - Python (FastAPI/Flask): TestClient
    - TypeScript (Node.js/Express): Supertest

```csharp
public class UserControllerTests : IClassFixture<WebApplicationFactory<Program>>
{
    private readonly HttpClient _client;

    public UserControllerTests(WebApplicationFactory<Program> factory)
    {
        _client = factory.CreateClient();
    }

    [Fact]
    public async Task GetUser_WithValidId_ReturnsOk()
    {
        var response = await _client.GetAsync("/api/users/1");
        response.EnsureSuccessStatusCode();
        var user = await response.Content.ReadFromJsonAsync<UserDto>();
        Assert.NotNull(user);
        Assert.Equal(1, user.Id);
    }
}
```

## 注意事項

- 実行速度: 単体より遅い。数は単体より少なく（テストピラミッド）
- 不安定さ対策 (Flakiness): 原因切り分け可能に設計。リトライ等の戦略を検討
- CI実行: Pull Request時は必須、プッシュごとの実行はスキップする等の戦略も可
