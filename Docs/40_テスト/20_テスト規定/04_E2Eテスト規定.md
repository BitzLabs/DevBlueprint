# E2Eテスト規定

このドキュメントは、E2E (End-to-End) テストの実装に関する具体的な規約を定めます。E2Eテストは、ユーザーのようにシステムを操作し、主要な機能がシナリオ通りに連携して動作することを保証します。

## 定義と目的

- 定義: UI層からデータベースや外部サービスまで含めた、システム全体を通したワークフローを検証
- 目的:
    - 主要な利用シナリオが本番環境に近い状態で正しく機能することを保証
    - ビジネスプロセス全体の整合性の検証

## スコープ（対象範囲）

E2Eテストは作成・維持のコストが高いため、「広く浅く」を基本に、以下の主要シナリオに絞って作成します。

- ユーザー認証フロー（登録→ログイン→ログアウト）
- 主な業務フロー（例: EC: 検索→カート→購入完了 / SNS: 投稿→表示→リアクション）
- 決済フロー（外部決済連携）
- クリティカルな設定変更（パスワード変更等）

!!! warning "E2Eで検証すべきでないこと"

- 全てのUI要素の見た目（ビジュアルリグレッションテストの領域）
- 全ての入力パターンやエッジケース（単体/結合でカバー）

## 推奨ツールとフレームワーク

- Playwright（推奨）: Chromium/Firefox/WebKitを単一APIでテスト。自動待機が強力
- Cypress: GUIでデバッグ容易
- Selenium: 多言語対応の事実上の標準。柔軟だが構築が重め

## 実装パターン

### Page Object Model (POM)

- 目的: UI変更に対するテストコードの脆弱性を低減し、保守性を高める
- ルール:
    - 各ページ/主要コンポーネントに対応する「ページオブジェクト」クラスを作成
    - セレクタ/操作はページオブジェクト内にカプセル化。テストコードはページオブジェクトのメソッドを呼ぶ

```typescript
// 例: Playwright
export class LoginPage {
    constructor(private readonly page: Page) {}
    private get usernameInput() {
        return this.page.locator('#username');
    }
    private get passwordInput() {
        return this.page.locator('#password');
    }
    private get loginButton() {
        return this.page.locator('button[type="submit"]');
    }
    async goto() {
        await this.page.goto('/login');
    }
    async login(username, password) {
        await this.usernameInput.fill(username);
        await this.passwordInput.fill(password);
        await this.loginButton.click();
    }
}
```

## 注意事項

- 実行時間とコスト: 実行は限定的なステージ（リリース前、夜間バッチなど）に
- テストデータ管理: クリアな初期状態を準備する前処理を組み込む
- 不安定さ対策: 自動待機機能を活用し、固定時間待機は避ける
