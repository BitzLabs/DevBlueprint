# モック・スタブ規定

本規定は、テストダブル（モック/スタブ/フェイク/スパイ）の使い分け、設計原則、実装指針を定めます。

## 用語整理

- スタブ: 事前に決めた戻り値/振る舞いを返す軽量な代替
- モック: 期待された呼び出し（回数/引数）を検証可能な代替
- フェイク: 簡易実装（インメモリ DB など）
- スパイ: 呼び出し履歴を記録し後で検証

## ポリシー

- 単体テストでは外部 I/O（DB/ネットワーク/時間/乱数）をテストダブルで隔離
- 結合テストでは境界を跨ぐ実物を 1 つずつ増やし、主要パスで実環境に近づける
- 期待の過剰固定を避け、公開 API の契約に基づいて検証

## 実装指針

- 依存性注入（DI）を標準化し、テストで代替実装を注入できる設計にする
- 時刻・UUID・乱数はサービス化しテストで固定値を供給
- ネットワーク呼び出しは HTTP クライアントを抽象化し、録画再生（VCR）や MSW を活用
- ロガーはインタフェース化し、テスト時はサイレント/アサート可能

## 落とし穴回避

- 実装詳細への過剰な verify（内部メソッド呼び出しなど）を避ける
- 過度なモックによりリファクタリング耐性が低下しないよう、契約中心に
- 並行テストで共有スタブを使い回さず、テスト毎に生成

## エビデンス

- 期待/呼び出し履歴の検証結果をテスト出力に残す
- 録画再生を用いる場合はカセットのバージョン管理と失効ポリシーを設ける
