承知いたしました！ `05_コーディング規則.md` の「言語機能の利用方針」で「将来対応」としていた項目（ファイルスコープ名前空間や `global using` など）を、今回の再構築で**最初から採用する**ということですね。これは、最新のC#の機能を活用して、よりクリーンでモダンなコードベースを構築する上で非常に良い判断です。

それでは、その方針を反映させた **`Docs/02.開発仕様書/05_コーディング規則.md`** の最終FIX版を提示します。

--- START OF FILE # `Docs/02.開発仕様書/05_コーディング規則.md` (言語機能更新 反映版) ---

# 05_コーディング規則

このドキュメントでは、BitzBufferプロジェクトで採用するC#のコーディングスタイルと規約について説明します。
一貫性のあるコードは、可読性、保守性、および共同作業（将来的なコントリビューターを含む）の効率を向上させます。

## 1. 基本方針

本プロジェクトのコーディングスタイルは、基本的に **Microsoftが提唱するC#のコーディング規則** に準拠します。
詳細は以下の公式ドキュメントを参照してください。

*   [C# のコーディング規則 (C# プログラミング ガイド) - Microsoft Docs](https://learn.microsoft.com/ja-jp/dotnet/csharp/fundamentals/coding-style/coding-conventions)
*   [名前付けのガイドライン - Microsoft Docs](https://learn.microsoft.com/ja-jp/dotnet/standard/design-guidelines/naming-guidelines)
*   [.NET ランタイムチームのコーディング スタイル - GitHub](https://github.com/dotnet/runtime/blob/main/docs/coding-guidelines/coding-style.md) (より詳細な例として参考)

以下に、BitzBufferプロジェクトにおいて特に意識したい主要なポイント、および補足事項をまとめます。

## 2. 命名規則 (Naming Conventions)

Microsoftの「[名前付けのガイドライン](https://learn.microsoft.com/ja-jp/dotnet/standard/design-guidelines/naming-guidelines)」に準拠します。主要なものは以下の通りです。

*   **PascalCase**: クラス名、メソッド名、プロパティ名、イベント名、enum型名、enumメンバー名、定数 (`const`)、読み取り専用静的フィールド (`static readonly`)。
*   **camelCase**: メソッドの引数名、ローカル変数名。
*   **インターフェース名**: 接頭辞 `I` を付け、PascalCase。例: `IBufferProvider`。
*   **プライベートインスタンスフィールド**: 接頭辞 `_` を付け、camelCase。例: `_internalBuffer`。
*   **非公開の静的フィールド**: `s_` プレフィックス (camelCase) または `t_` プレフィックス (スレッド静的な場合、camelCase)。

## 3. レイアウトと書式設定 (Layout and Formatting)

*   **インデント**: 半角スペース4つ。タブは使用せず、エディタの設定でスペースに自動変換することを推奨します。
*   **波括弧 `{}`**:
    *   型定義、名前空間: 波括弧は次の行 (Allmanスタイル)。
    *   制御フローステートメント: 波括弧は同じ行。
    *   1行のステートメントでも、常に波括弧を使用します。
*   **1行の長さ**: 約120文字以内を目安とします。
*   **空行**: メソッド間、論理ブロック間に適切に挿入します。
*   **スペース**: 演算子、カンマの前後などに適切に挿入します。
*   **`this.` の使用**: 原則として、曖昧さがない限り `this.` は省略します。

## 4. コメント (Comments)

*   **XMLドキュメントコメント (`///`) の不使用:**
    *   本プロジェクトでは、ソースコードの可読性を優先するため、**公開APIに対するXMLドキュメントコメント (`///`) は原則として使用しません。**
    *   APIの仕様や説明は、「[`06_インターフェイス規則.md`](./06_インターフェイス規則.md)」で定めるガイドラインに従い、別途Markdown形式のAPI仕様書に記述します。
*   **通常のコメント (`//` または `/* ... */`)**:
    *   コードの意図が自明でない場合、複雑なロジック、将来の改善点（`// TODO:`）などを説明するために使用します。
    *   コードが「何をしているか」よりも「**なぜそうしているのか**」という設計意図や背景を説明するように心がけます。
    *   コメントは、コードの変更に合わせて常に最新の状態に保ちます。

## 5. 言語機能の利用方針

ターゲットフレームワークは .NET 6 以上であるため、最新のC#言語機能を適切に活用し、コードの簡潔性、可読性、安全性を高めることを目指します。

*   **`var` の使用**: 型が右辺から明らかで、可読性を損なわない場合は積極的に使用。
*   **LINQ**: コレクション操作に推奨。パフォーマンスがクリティカルな箇所はプロファイリングの上で判断。
*   **プロパティ**: フィールドは原則 `private`、外部アクセスはプロパティ経由。
*   **`using` ステートメント/宣言**: `IDisposable` リソースに必須。
*   **null許容参照型 (`#nullable enable`)**: プロジェクト全体で有効化します。
*   **式形式メンバー**: 単純なメソッドやプロパティに利用可。
*   **タプル**: 複数値を返す場合に適切に利用。
*   **パターンマッチング**: 型チェックや条件分岐に積極的に活用。
*   **レコード型 (`record class`, `record struct`)**: データ保持、値の等価性、イミュータビリティが重要な場合に推奨。
*   **`init` アクセサ**: オブジェクト初期化時のみ設定可能なプロパティに使用。
*   **ファイルスコープ名前空間**: C# 10.0以降。新しいファイルでは積極的に採用します。
*   **`global using` ディレクティブ**: C# 10.0以降。プロジェクト全体で共通して使用する名前空間は、専用のファイル (例: `GlobalUsings.cs`) にまとめて定義します。

## 6. エラー処理と例外 (Error Handling and Exceptions)

*   APIの境界では、不正な引数などに対して標準的な例外 (`ArgumentNullException`等) をスローします。
*   エラーの握りつぶしや汎用的な `Exception` のキャッチは避けます。
*   詳細なエラーハンドリング戦略は「`../03.詳細仕様書/BitzBuffer/05_エラーハンドリング.md`」を参照してください。

## 7. 非同期処理 (`async`/`await`)

*   I/Oバウンドな操作や長時間実行される可能性のある処理（特にBitzBuffer.Pipelines）では、`async` および `await` を適切に利用します。
*   公開APIとして非同期メソッドを提供する場合は、命名規則（末尾 `Async`）に従います。
*   ライブラリコード内では、原則として `ConfigureAwait(false)` を使用し、呼び出し元のコンテキストへの不要な復帰を避けます。

## 8. その他

*   **イミュータビリティ**: 可能な限り、イミュータブルな型やデータ構造の利用を検討します。
*   **コメントアウトされたコード**: 不要なコードは残さず、Gitで履歴を管理します。
*   **警告の扱い**: コンパイラの警告は原則として全て修正します。意図的な抑制は理由を明記し最小範囲で。

## 9. コミットメッセージ

コミットメッセージの規約については、「[`02_ブランチ戦略と命名規則.md`](./02_ブランチ戦略と命名規則.md)」を参照してください。

--- END OF FILE ---

**主な変更点:**

*   **「5. 言語機能の利用方針」:**
    *   `null許容参照型` の記述を「有効化を強く推奨」から「**有効化します**」に変更。
    *   `ファイルスコープ名前空間` の記述を「新しいファイルでは積極的に採用」から「**新しいファイルでは積極的に採用します**」に変更。
    *   `global using` ディレクティブの記述を「共通の名前空間は専用のファイルにまとめて定義します」とし、将来的な検討ではなく、採用する方針として記述しました。
*   その他、全体的に表現を微調整し、BitzBufferプロジェクトの規約として確定的なニュアンスを強めました。

この `05_コーディング規則.md` の修正版でよろしいでしょうか？
ご確認いただき、問題なければ次に `06_インターフェイス規則.md` のBitzBuffer版を提示します。