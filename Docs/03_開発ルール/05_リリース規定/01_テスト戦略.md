# 07. テスト戦略

このドキュメントは、BitzBufferライブラリの品質を保証し、信頼性を高めるためのテスト戦略について定義します。高品質なソフトウェアを提供するためには、網羅的かつ効率的なテストが不可欠です。このドキュメントは、BitzBufferにおけるテストの目的、範囲、種類、実施方法、および管理に関する基本的な方針を示します。

## 1. テストの目的

BitzBufferにおけるテストの主な目的は以下の通りです。

- **FR-TEST-PURP-001: 機能の正当性検証:**
  ライブラリの各機能が設計仕様通りに正しく動作することを確認します。
- **FR-TEST-PURP-002: バグの早期発見と修正:**
  開発サイクルの早い段階で不具合を発見し、修正コストを低減します。
- **FR-TEST-PURP-003: リグレッションの防止:**
  コード変更や機能追加によって、既存の機能が損なわれないこと（デグレードしないこと）を保証します。
- **FR-TEST-PURP-004: 設計とコードの品質向上:**
  テスト容易性を考慮した設計を促進し、結果としてコードのモジュール性や保守性を高めます。
- **FR-TEST-PURP-005: ドキュメントとしての役割:**
  テストコード自体が、ライブラリのAPIの具体的な使用方法を示す生きたドキュメントとしての役割も果たします。
- **FR-TEST-PURP-006: パフォーマンスの確認:**
  主要な機能について、許容可能なパフォーマンス範囲内であることを確認するための基本的なベンチマークテストを実施します。

## 2. テストの範囲

テストの対象範囲は、BitzBufferライブラリを構成する全てのコンポーネントとします。

- **FR-TEST-SCOP-001: コアインターフェースと実装クラス:**
  - `IBuffer<T>`
    および関連インターフェースを実装する各クラス (`ManagedBuffer<T>`,
    `NativeBuffer<T>`, `SegmentedManagedBuffer<T>`, `SegmentedNativeBuffer<T>`,
    `SlicedBufferView<T>`) の全ての公開API。
  - 所有権管理、ライフサイクル（`Dispose`）、データ操作（`Write`, `Advance`,
    `AttachSequence`など）のロジック。
- **FR-TEST-SCOP-002: バッファ管理機構:**
  - `BufferManager` のプロバイダ登録・取得機能。
  - `IBufferProvider` の `Rent` および `CreateBuffer` 機能。
- **FR-TEST-SCOP-003: プーリング戦略:**
  - `IBufferPoolStrategy`
    の実装。特に、バケット管理、貸し出しと返却のロジック、上限管理。
  - `IBufferLifecycleHooks`
    のフックが適切なタイミングで呼び出され、正しく機能すること。
- **FR-TEST-SCOP-004: BitzBuffer.Pipelines (将来):**
  - `BitzPipe<T>`, `BitzPipeReader<T>`, `BitzPipeWriter<T>` のコア機能。
  - バックプレッシャー、完了処理、エラー伝播などのロジック。
  - 各トランスポート層（IPC, Network, Serial）の実装。
- **FR-TEST-SCOP-005: エラーハンドリング:**
  - 不正な引数や状態でのAPI呼び出し時に、期待される例外がスローされること。
  - `Try...` パターンが失敗時に正しく `false` を返すこと。

## 3. テストの種類とアプローチ

BitzBufferでは、品質を多角的に保証するために、以下の種類のテストを組み合わせて実施します。

- **FR-TEST-TYPE-001: 単体テスト (Unit Tests):**
  - **目的:**
    ライブラリ内の最小単位のコンポーネント（クラス、メソッドなど）が個別に正しく機能することを確認します。
  - **アプローチ:**
    - 各公開メソッドおよび重要な内部メソッドに対してテストケースを作成します。
    - 正常系、異常系（不正な引数、境界値）、エッジケースを網羅します。
    - 依存関係はモックやスタブを用いて分離し、テスト対象のユニットに集中します。
  - **ツール:** **xUnit.net**
    を使用します。モックライブラリとしては Moq や NSubstitute などを適宜検討します。
- **FR-TEST-TYPE-002: 結合テスト (Integration Tests):**
  - **目的:**
    複数のコンポーネントを組み合わせて連携させた際に、全体として正しく機能することを確認します。
  - **アプローチ:**
    - 「`BufferManager` でプロバイダを設定」→「プロバイダからバッファを
      `Rent`」→「バッファを操作」→「`Dispose`
      してプールに返却」といった一連のフローをテストします。
    - `IBufferProvider` と `IBufferPoolStrategy`, `IBufferLifecycleHooks`
      の連携をテストします。
    - `TryAttachZeroCopy` を使った `Segmented...Buffer<T>`
      間の所有権移譲と、その後のライフサイクル管理が正しく行われることをテストします。
- **FR-TEST-TYPE-003: マルチスレッドテスト (Concurrency Tests):**
  - **目的:**
    スレッドセーフであるべきコンポーネント（プーリング戦略、`BufferManager`
    など）が、複数のスレッドから同時にアクセスされても正しく動作し、データ破損やデッドロックが発生しないことを確認します。
  - **アプローチ:**
    - 複数のスレッドを生成し、同時に `Rent` や `Return`
      を繰り返し呼び出すテストを作成します。
    - `Task.Run`, `Parallel.ForEach`, `CountdownEvent`
      などを活用して、競合状態を意図的に発生させます。
- **FR-TEST-TYPE-004: パフォーマンステスト (Performance Tests) / ベンチマーク:**
  - **目的:** 主要な機能（特にバッファの
    `Rent`/`Return`、`Write`/`Advance`）のパフォーマンスが、許容範囲内であるかを確認し、リグレッションを検出します。
  - **アプローチ:**
    - **BenchmarkDotNet**
      を利用し、標準的なシナリオに対するスループット、レイテンシ、メモリアロケーションを測定します。
    - 定期的に実行し、パフォーマンスの推移を監視します。
- **FR-TEST-TYPE-005: リソースリークテスト:**
  - **目的:** バッファ（特にネイティブリソース）が、`Dispose`
    されなかった場合や、複雑な所有権移譲の後でも、最終的にリークせず解放されることを確認します。
  - **アプローチ:**
    - テスト内で意図的に `Dispose`
      を呼ばずにGCを発生させ、ファイナライザが正しく動作すること（または警告が出ること）を確認します。
    - メモリプロファイラを併用して、長時間のストレステスト後にアンマネージドメモリの使用量が元に戻ることを確認します。

## 4. テストの実施と管理

- **FR-TEST-IMPL-001: テストコードの場所:**
  - テストコードは、「[`01.フォルダ構成.md`](./01.フォルダ構成.md)」で定義された`Tests/`
    フォルダ以下の専用テストプロジェクトに格納します。
- **FR-TEST-IMPL-002: 自動化 (CI):**
  - 全ての単体テストと結合テストは、CI
    (継続的インテグレーション) プロセスの一部として実行します。（詳細は
    [`08.ビルドとリリース手順`](./08.ビルドとリリース手順.md)）
- **FR-TEST-IMPL-003: テストカバレッジ:**
  - コードカバレッジツール（例:
    Coverlet）を利用してテストカバレッジを測定し、高いカバレッジを維持するよう努めます。
- **FR-TEST-IMPL-004: テストの命名規則:**
  - テストメソッド名は、`MethodName_Condition_ExpectedResult`
    のような、テスト内容が明確に分かる命名とします。
- **FR-TEST-IMPL-005: プルリクエストとテスト:**
  - 新しい機能の追加やバグ修正を行う際は、必ず対応するテストコードを作成または更新し、プルリクエストに含めます。
  - プルリクエストは、全ての関連テストが成功することをマージの条件とします。
